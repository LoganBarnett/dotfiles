#!/usr/bin/env bash
set -e

source ~/.bash-logging

if ! which jq > /dev/null ; then
  slog "oq not found on PATH, which is required for $0. Exiting..."
  exit 2
fi

baseUrl=$1
secretServerDomain=$2
username=$3
# Not required for self-hosted Secret Server.
organizationCode=$4
function input() {
  local in
  read in
  printf "%s" "$in"
}
password="$(input)"

function soap() {
  url="$baseUrl/Authenticate?\
username=$username\
&password=$password\
&organization=$organizationCode\
&domain=$secretServerDomain\
"

  slog "$url"
  curl -L -X GET "$url"
}

function rest() {
  url="$baseUrl/oauth2/token"
  grantType="password"
  curl "$url" \
    --silent \
    -X POST \
    --data-urlencode "domain=$secretServerDomain" \
    --data-urlencode "username=$username" \
    --data-urlencode "password=$password" \
    --data-urlencode "grant_type=$grantType" \
    | jq -r '.access_token'
}

rest
